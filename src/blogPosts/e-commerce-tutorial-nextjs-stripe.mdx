---
slug: "blog/e-commerce-tutorial-nextjs-stripe"
title: "Build an E-commerce Website with Webiny Serverless Headless CMS, Next.js, and Stripe"
description: "In this tutorial, we'll create an e-commerce website using Webiny Serverless Headless CMS, Next.js, and Stripe."
tags: ["Serverless", "Web development", "Javascript", "Software Development", "GraphQL"]
featureImage: "./assets/e-commerce-tutorial-nextjs-stripe/e-commerce-tutorial-nextjs-stripe-cover.png"
author: albiona
date: 2020-10-19
---

In this tutorial we will create a simple e-commerce website, where you can buy Swag from the best Open Source Projects such as Webiny, Next.js, React, etc.

Before we continue, let's go through what you'll learn on building this website.

You will learn how to create the back-end with <ExternalLink href="http://docs.webiny.com/docs/webiny-apps/headless-cms/features/content-modeling?utm_source=Webiny-blog&utm_medium=webiny-headless-cms-features-docs&utm_campaign=webiny-blog-e-commerce-tutorial-oct-19&utm_content=webiny-headless-cms-features-docs&utm_term=W00180">Webiny Headless CMS</ExternalLink>
with two content models, the products, and the categories.
Then, fetching the data from the headless CMS to the Next.js project using Apollo GraphQL.
Last but not least, integrating Stripe to implement a shopping cart for our products.

While working on this starter, I shared my progress on Twitter and <ExternalLink href="https://twitter.com/joshuaackerman">Josh</ExternalLink> from Stripe <ExternalLink href="https://twitter.com/joshuaackerman/status/1305857426059653122?s=20">reached out</ExternalLink> for being available for any feedback regarding improvements, developer experience and documentation,
thank you, Josh!

Without further ado let's get started.

// New gif will come here
![e-commerce gif](./assets/e-commerce-tutorial-nextjs-stripe/e-commerce-2.gif)

TLDR; <ExternalLink href="http://www.github.com/webiny/webiny-examples/new_link_zhere">Get the code here</ExternalLink>

## 1. The e-commerce-starter

To get started, we'll clone the `e-commerce-starter` git repository.
The starter will have a ready-made Next.js application, and the Ant Design UI Library set up
that looks like in the image below.

![E commerce starter](/assets/e-commerce-tutorial-nextjs-stripe/e-commerce-starter.png)

We already have some components and functionalities ready, such as the `Header`, `Search`, `Product List`, the `Product` card, and the `Cart` component.

Clone the `e-commerce-starter` project by running the following commands to have the project set up and running.

```
  git clone https://github.com/AlbionaHoti/e-commerce-start // will update the link
  cd e-commerce-start
  npm install
  npm run dev

  // head over to localhost:3000
```

Now that we have the starter project, we can focus on creating the back-end with Webiny headless CMS and fetching the data to our front-end.

## 2. Webiny Headless CMS

Webiny provides several serverless websites such as the Headless CMS, Page Builder, Form Builder and File Manager.
In this tutorial, we are going to use the Headless CMS only.

### Prerequisites

- A Webiny Headless CMS Project

  First of all, make sure you have a working <ExternalLink href="http://docs.webiny.com/docs/get-started/quick-start">Webiny project</ExternalLink> set up.

> When setting up a new project, currently, there are two project templates you
> can choose from: `full` and `cms`. Both include the Headless CMS app by default.

- Content Delivery API URL

  The Headless CMS app exposes data via the `Content Delivery API`,
  which is a simple GraphQL API that dynamically updates its schema on
  content model changes that you make. Once you have deployed your API stack
  (using the `yarn webiny deploy api --env=local` command), you should be able to
  find the Content Delivery API URL in the `API Information` menu item, in your admin app.

- Content Delivery API Access Token

  In order to access the data via the Content Delivery API, we'll need a valid Access Token.

  1.  Follow the <ExternalLink href="http://docs.webiny.com/docs/webiny-apps/headless-cms/features/access-tokens/">link</ExternalLink> here to create an access token for a specific environment.
  2.  Use this access token as a HTTP header to your GraphQL Playground in `/cms/read/{alias}` endpoints.
      ![Access token auth](/assets/e-commerce-tutorial-nextjs-stripe/access-tokens-graphql.png)

  > In the root of the `e-commerce-starter` app that you set up,
  > you will find the `.env` file, that's the place where we need to save the Content Delivery API, and the Content Delivery API Access Token

Now that we have all of the prerequisites out of the way, it's time to create our first content model for the e-commerce website.

We are going to create two content models, the `products` and `category`

- Products
  - 6 Created Products
- Category
  - 3 Created Categories

Let's go through the images below and create the content models for products and categories.

The `Products` content model.

![Products content model](/assets/e-commerce-tutorial-nextjs-stripe/products_content_model.png)

The `Products` content model, will contain the fields as shown in the image:

- Title - `Text`
- Image - `Files`
- Price - `Number`
- Description - `Long text`
- Permalink - `Text`, and
- Category - `Reference(multiple values)`.

When adding a `Reference field`, you can toggle the `Use as a list of references` switch in field settings, to do a multi-select. In this case, a product can have multiple categories.

![](/assets/e-commerce-tutorial-nextjs-stripe/products_ref_field.png)

The `Category` content model.

![Category content model](/assets/e-commerce-tutorial-nextjs-stripe/category_content_model.png)

The `Category` content model will contain the fields such as:

- Title - `Text(entry title)`
- Products - `Reference(multiple values)`

We toggle the `Use as a list of references` for the category can have multiple Products.

Now that we have created the content models, click on View Content and start creating your Swag products and the categories üéâ

## 3. Next.js + Apollo GraphQL to fetch data from the backend

We are going to start off by installing a few NPM packages:

- `@apollo/client` - This single package contains virtually everything we need to set up Apollo Client. It includes the in-memory cache, local state management, error handling, and a React-based view layer.

- `graphql` - This package provides logic for parsing GraphQL queries.

```
npm i @apollo/client graphql --save
```

Now that we installed the necessary packages, lets check the e-commerce-starter website structure in the image below:

![E commerce starter structure](/assets/e-commerce-tutorial-nextjs-stripe/e-commerce-starter-structure.png)

- `/components` folder contains the react antd starter components, as seen in the image above.
- `/context/context.js` contains the React context that holds the state of the `Cart`, `Favorite` products, `Modal` of Products Cart, and `Total` price of the cart.
- `/pages/_app.js` component file is provided by Next.js, and serves as a wrapper of every single Next.js page of your front-end.
  The `_app.js` file allows us to wrap the `Apollo Provider` around the function component so that we can have it available in every single page.

Now, you may ask What is Apollo Provider‚ÅâÔ∏è Good point ‚ÄºÔ∏è

---

Now that we have covered the packages used and the folder structure of our `e-commerce-starter` app, let's jump on the code.

Open the `_app.js` file and paste the following snippet:

`gist:AlbionaHoti/22688a0c4fac917a17f3ddaec13fc9b5`

Now that we've seen what the `_app.js` is made of, lets dig into the actual GraphQL client file.

Go ahead in the root of the project, and create the `lib/apolloClient.js` file, and paste the following snippet:

`gist:AlbionaHoti/3d251625b1665f06c05cc7d6d643764b`

The one important bit of the above snippet is the new instance of `ApolloClient`
which has some options such as the `link` ‚Üí this is the part where we
tell the Apollo how to go and fetch the data, and we do that by calling a new instance of `HttpLink`,
and pass the options to this, which is the `uri` ‚Üí That means: `Where on the internet does your GraphQL URL exists?` üöÄ
This is where the Webinys Content Delivery API Url comes into play.

We noted on the Webiny Headless CMS section: `In order to access the data via the Content Delivery API, we'll need a valid` <ExternalLink href="http://docs.webiny.com/docs/webiny-apps/headless-cms/features/access-tokens/">Access Token</ExternalLink>

So, in the headers, we pass the `authorization` with our Access Token.

Now, finally we are going to start fetching the actual content from our headless CMS back-end project. üöÄüöÄ

With this set-up, now we have the `apolloClient` that is passed to the `ApolloProvider` in
the `_app.js` file, for the `ApolloProvider` wraps every single page within our application,
we can actually go into a page, and import a hook called `useQuery` and the `gql`.
With these two, we can perform queries against our GraphQL API. Let's do that!

Navigate to the `components/ProductList.js` file, and paste the below snippet:

`gist:AlbionaHoti/6de0c012c0041e883f34be3a40db50b9`

We've defined our `QUERY`, now we will use the query with the `useQuery` hook, which will return the `data`, the `error`, and a boolean `loading`,
for whether it's still loading the data.

When we get the data from the headless CMS, we are implementing a simple `search` functionality for the products.
We receive the `search` value through the `props` of the `ProductList` component.

Before jumping on the `localhost:3000/` to see the actual data, we need to add one more detail!

> Next.js provides different methods for fetching data, one of them is `getStaticProps` - this method allows you to update existing pages by re-rendering them in the background as traffic comes in.

Navigate to the `pages/index.js` file, and paste the following snippet:

`gist:AlbionaHoti/d1941660f432658116dfc87d330c8d61`

The `getStaticProps` function gets called at build time on server-side.
It won't be called on client-side, so you can even do direct database queries.

Inside this function, we are querying our GraphQL API, and cashing the data in the background. Now, you can freely update your content on the Webiny headless CMS üéâ

Now that we have the data, let's go and check the `ProductCard` component that came
with the `e-commerce-starter` pack üöÄ Navigate to the `components/Product.js` file,
there you'll find the product cart functionalities such as `addToCart`,
`removeFromCart`, and `addToFavorites`. One functionality is missing though,
and that is the `goToProduct` that should open a modal, and show the product details‚ÅâÔ∏è

> <ExternalLink href="https://www.webiny.com/blog/webiny-hacktoberfest-2020">
>   Webiny Hacktoberfest 2020{" "}
> </ExternalLink>

You can freely open a PR for the `goToProduct` function and make it your first PR @ <ExternalLink href="https://www.webiny.com/">Webiny</ExternalLink>. üë©üèª‚ÄçüöÄ

## 4. Next.js + Stripe to create the payment intents

In this starter we will use the <ExternalLink href="https://stripe.com/docs/payments/payment-intents">Stripe </ExternalLink> Payment intents API with Next.js and follow best practices as set out by Stripe and the industry.

To set up the Next.js project using Stripe, we have to create a <ExternalLink href="https://stripe.com/">Stripe account</ExternalLink>, and get the `Secret key`, and the `Publishable key` from <ExternalLink href="https://dashboard.stripe.com/test/apikeys">Stripe Developer API Keys Dashboard</ExternalLink>.

Again, follow up the project here, to get all the necessary code files for the project, we will focus only on the main parts of setting up the Stripe with Next.js.

### Server and Client Side

As mentioned early that on the `checkout` page we will use the `getServerSideProps` life cycle method of Next.js, where we will create the Payment intent.

Create the `checkout.js` file in the `pages` folder, and paste the following snippet:

`gist:AlbionaHoti/a2355927e3a79f2db0bd6c78c47a929d`

Let's go through the code and explain what are we doing here.

For the server side, in the `getServerSideProps` life cycle method we are storing a cookie where we check, if a payment intent was created or not, and for that we are using the `nookies` library. Make sure to update the `STRIPE_SECRET_KEY_HERE`, and the `STRIPE_PUBLISHABLE_KEY_HER`with your keys.

Now, from the client side, we are using the client side Stripe libraries: `@stripe/stripe-js` and `@stripe/react-stripe-js` to create a secure `paymentMethod` which contains our card information that is passed onto Stripe.

We created `stripePromise` to pass the `Elements` provider, and with the `stripePromise` and the `Elements` provider we are going to wrap the `CheckoutForm` component where we pass the `paymentIntent` from props to CheckoutForm.

### Checkout Form

Regarding the `CheckoutForm` component, create a file in the `components/CheckoutForm.js` and paste the following snippet:

`gist:AlbionaHoti/e4b6d3c0c8b283c397245559c0edb63b`

Let's go through the code and understand what are we doing here. `@stripe/react-stripe-js` exposes hooks and components that we can use, such as:

- `CardElement`
- `useStripe`
- `useElements`

The two stripe hooks, we will be using inside the `handleSubmit` function to have a reference to `stripe` and `elements`.

Now, regarding the stripe intent confirmation, Stripe provides the `confirmCardPayment` which accepts 3 arguments: the `client_secret`, and the optional `data`, and `options`.

From the props of `paymentIntent`, we have access to the `client_secret`, and on line 94, we update the handleSubmit function to send a request to Stripe to confirm the Payment intent.

The other important bits, are the `request` to `/api/payment_intents` and the `CardElement` where Stripe provides a fully secure and baked credit card input with expiry, CVV and zip/post code. For the `/api/payment_intents` we update the payment intent with the newly cart amount from the React context as shown at the line `82`.

Paste the following snippet in your `api/payment_intents.js` file:

`gist:AlbionaHoti/f3a8fb683ca6f0adbae83361a77db6e0`

# Conclusion

![https://media.giphy.com/media/TdfyKrN7HGTIY/giphy.gif](https://media.giphy.com/media/TdfyKrN7HGTIY/giphy.gif)
